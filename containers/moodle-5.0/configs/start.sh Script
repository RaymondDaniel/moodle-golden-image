#!/bin/bash set -e # Wait for database to be ready echo "Waiting for database connection..." until nc -z "$DB_HOST" 3306; do echo "Database not ready, waiting..." sleep 2 done echo "Database is ready!" # Mount Filestore if not already mounted if ! mountpoint -q /var/moodledata; then echo "Mounting Filestore..." mount -t nfs -o nfsvers=3 "$FILESTORE_IP:/moodledata" /var/moodledata echo "Filestore mounted successfully" fi # Set proper permissions chown -R www-data:www-data /var/moodledata chmod -R 755 /var/moodledata # Create necessary directories mkdir -p /var/log/moodle /tmp/moodle chown -R www-data:www-data /var/log/moodle /tmp/moodle # Replace placeholders in configuration sed -i "s/REDIS_HOST/$REDIS_HOST/g" /usr/local/etc/php-fpm.d/www.conf sed -i "s/REDIS_AUTH/$REDIS_AUTH/g" /usr/local/etc/php-fpm.d/www.conf # Start supervisord echo "Starting services..." exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
